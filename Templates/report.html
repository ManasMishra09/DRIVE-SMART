<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Pathhole-Tracker</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Raleway:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="{{ url_for('static', filename = 'assets/vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename = 'assets/vendor/bootstrap-icons/bootstrap-icons.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename = 'assets/vendor/aos/aos.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename = 'assets/vendor/glightbox/css/glightbox.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename = 'assets/vendor/swiper/swiper-bundle.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename = 'assets/vendor/remixicon/remixicon.css') }}" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="{{ url_for('static', filename = 'assets/css/main.css') }}" rel="stylesheet">

  <style type="text/css">
    *{
      overflow-x: hidden;
    }
    .reporttable th{
      text-align: center;
      color: white;
      background-image: linear-gradient(90deg, #0367a6 0%, #008997 74%);
      font-weight: bold;
      border: 1px solid #0367a6;
    }
    .reporttable td{
      text-align: center;
      border: 1px solid #0367a6;
      padding: 6px;
    }

    .action{
      cursor: pointer;
      color: white;
      border-radius: 3px;
      padding: 5px;
      background-image: linear-gradient(90deg, #0367a6 0%, #008997 74%);
    }
  </style>

</head>

<body class="page-team">

  <!-- ======= Header ======= -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container-fluid container-xl d-flex align-items-center justify-content-between">

      <a href="index.html" class="logo d-flex align-items-center">
        <!-- Uncomment the line below if you also wish to use an image logo -->
        <!-- <img src="assets/img/logo.png" alt=""> -->
        <h1 class="d-flex align-items-center">Pathhole Tracker</h1>
      </a>

      <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
      <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>

     <nav id="navbar" class="navbar">
        <ul>
          <li><a href="{{ url_for('homepage') }}" class="active">Home</a></li>
          <li><a href="{{ url_for('pathhole') }}">Pathhole Register</a></li>  
          <li><a href="{{ url_for('report') }}">Reports</a></li>  
          <li><a href="{{ url_for('about') }}">About</a></li>
          <li><a href="{{ url_for('contact') }}">Contact</a></li>
          <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
      </nav><!-- .navbar -->
    </div>
  </header><!-- End Header -->

  <main id="main">

    <!-- ======= Breadcrumbs ======= -->
    <div class="breadcrumbs d-flex align-items-center" style="background-image: url({{ url_for('static', filename = 'images/addpath-back.jpg') }});">
      <div class="container position-relative d-flex flex-column align-items-center">

        <h2>Reports</h2>
        <ol>
          <li><a href="{{ url_for('homepage') }}">Home</a></li>
          <li>Reports</li>
        </ol>

      </div>
    </div><!-- End Breadcrumbs -->
    <br>
    <style type="text/css">
      .activetab{
        border-bottom: 4px solid #457c9c;
      }
    </style>
    <div class="row">
      <div class="col-md-3"></div>
      <div class="col-md-3 activetab" style="text-align: right;cursor: pointer;" id="imgreporttab"><h4>Image Reports</h4></div>
      <div class="col-md-3" id="livereporttab" style="cursor: pointer;"><h4>Live Map Reports</h4></div>
      <div class="col-md-3"></div>
    </div>
    <br><br>
    <div id="imgrep" style="margin-bottom: 25px">
        <table class="reporttable" id="reporttable" rules="all" style="width: 90%; margin: auto; text-align: center; border: 2px solid #0367a6;" >
          <thead>
            <tr>
              <th>Reference No</th>
              <th>Location</th>
              <th>Image</th>
              <th>Subject</th>
              <th>Message</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="accidentreports">
            
          </tbody>
      </table>
    </div>
    <div id="liverep" style="display: none" style="margin-bottom: 25px">
      <table class="reporttable" id="livereporttable" rules="all" style="width: 80%; margin: auto; text-align: center; border: 2px solid #0367a6" >
          <thead>
            <tr>
              <th>Reference No</th>
              <th>Start Location</th>
              <th>End Location</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="pathlivereport">
            
          </tbody>
      </table>
    </div>

    <div id="reportarea" style="width: 60%; margin: auto;display: none;">
      <div style="border: 1px solid black; padding: 20px">
        <center><h3>Pathhole Report</h3></center>
        <br>

        <p>Reference ID : <span id="refnum"></span></p>
        <p>Date : <span id="curtime"></span></p>
        <p>
          Hello There,<br><br>A pathhole found in the location :  <span id="location"></span> and it was reported on : <span id="reptime"></span>.<br><br>The user commented as : <span id="message"></span>. Kindly takes this as a consideration and the image of the pathhole is attached with this report.<br><br>This is an electronically generated report downloaded from pathhole reporting system reported by the user.<br><br>With regards,<br>Team Highway Authority.
        </p>
        <br><br>
        <p>Pathhole Image</p>
        <img height="200" width="200" id="pathholerepimg">
        <br><br>
        <p style="text-align: center;">*********************************************</p>
      </div>
      </div>

    </div>
  </main><!-- End #main -->



  <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="{{ url_for('static', filename = 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename = 'assets/vendor/aos/aos.js') }}"></script>
  <script src="{{ url_for('static', filename = 'assets/vendor/glightbox/js/glightbox.min.js') }}"></script>
  <script src="{{ url_for('static', filename = 'assets/vendor/swiper/swiper-bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename = 'assets/vendor/isotope-layout/isotope.pkgd.min.js') }}"></script>
  <script src="{{ url_for('static', filename = 'assets/vendor/php-email-form/validate.js') }}"></script>

  <!-- Template Main JS File -->
  <script src="{{ url_for('static', filename = 'assets/js/main.js') }}"></script>
  <script src="{{ url_for('static', filename = 'assets/js/jquery.js') }}"></script>

  <script type="text/javascript">

    $("#imgreporttab").click(function(){
      $("#imgreporttab").addClass("activetab")
      $("#livereporttab").removeClass("activetab")
      $("#imgrep").show()
      $("#liverep").hide()
    });

    $("#livereporttab").click(function(){
      $("#imgreporttab").removeClass("activetab")
      $("#livereporttab").addClass("activetab")
      $("#imgrep").hide()
      $("#liverep").show()
    });

    $.ajax({
      url:"/getreports", 
      type: "post", 
      dataType: 'json',
      data: {},
      beforeSend: function(){
            $(".loader").show();
        },
        success: function(output){
          let appenddata = ''
          if (output.length > 0){
            for(var i=0; i<= output.length-1; i++){
              appenddata += `<tr>
              <td>`+"PTH-"+output[i]["pathhole_id"]+`</td>
              <td>`+output[i]["location"]+`</td>
              <td>`+output[i]["imagename"]+`</td>
              <td>`+output[i]["subject"]+`</td>
              <td>`+output[i]["message"]+`</td>
              <td>`+output[i]["timestamp"]+`</td>
              <td><span class='action mail' onclick=sendmail(`+output[i]["pathhole_id"]+`)>Mail</span>&nbsp;&nbsp;<span class='action down' onclick=download(`+output[i]["pathhole_id"]+`)>Download</span></td>`
            }
          }else{
            appenddata = "<tr><td colspan = '6' style='text-align:center'>No Data Found!</td></tr>"
          }
          $("#accidentreports").html(appenddata);
          $(".loader").hide();
        },
        error:function(){
            $(".loader").hide();
            alert("Something went wrong! Please try again.")
          }
    });

    $.ajax({
      url:"/getlivereports", 
      type: "post", 
      dataType: 'json',
      data: {},
      beforeSend: function(){
            $(".loader").show();
        },
        success: function(output){
          let appenddata = ''
          if (output.length > 0){
            for(var i=0; i<= output.length-1; i++){
              appenddata += `<tr>
              <td>`+"LPTH-"+output[i]["pathhole_id"]+`</td>
              <td>`+output[i]["start_loc"]+`</td>
              <td>`+output[i]["end_loc"]+`</td>
              <td>`+output[i]["created_at"]+`</td>
              <td><span class='action mail' onclick=getmap(`+output[i]["pathhole_id"]+`)>Map</span></td>`
            }
          }else{
            appenddata = "<tr><td colspan = '6' style='text-align:center'>No Data Found!</td></tr>"
          }
          $("#pathlivereport").html(appenddata);
          $(".loader").hide();
        },
        error:function(){
            $(".loader").hide();
            alert("Something went wrong! Please try again.")
          }
        });

    function getmap(id){
        window.open('http://localhost:5000/pathholemap?lid=' + id, '_blank');
    }

    function sendmail(id){
      var receiver = prompt("Please enter receiver mail ID");
      var output = ''
      $.ajax({
        url:"/sendreportmail", 
        type: "post", 
        dataType: 'json',
        data: {"id":id, "receiver":receiver},
        beforeSend: function(){
            $(".loader").show();
        },
        success: function(data){
          alert("Mail Successfully send!")
        },
        error:function(){
            $(".loader").hide();
            alert("Something went wrong! Please try again.")
          }
      });
    }

    function download(id){
      
      var output = ''
      $.ajax({
        url:"/downloadreport", 
        type: "post", 
        dataType: 'json',
        data: {"id":id},
        beforeSend: function(){
          $(".loader").show();
        },
        success: function(data){
          var repname = "PTH-"+data[0]["pathhole_id"]
          var currentDate = new Date();
          var formattedDateTime = currentDate.toLocaleString();
          $("#pathholerepimg").attr("src","http://localhost:5000/static/output/"+data[0]["imagename"]);
          $("#refnum").html(repname)
          $("#curtime").html(formattedDateTime)
          $("#reptime").html(data[0]["timestamp"])
          $("#location").html(data[0]["location"])
          $("#message").html(data[0]["message"])
        },
        error:function(){
            $(".loader").hide();
            alert("Something went wrong! Please try again.")
          }
      });

       setTimeout(function() {
        var accidentReport = $("#reportarea").html();
        var printWindow = window.open('', '', 'height=400,width=800');
        printWindow.document.write(accidentReport);
        printWindow.document.close();
        printWindow.print();
        printWindow.close();
      }, 2000);
    
    }

  </script>
</body>

</html>